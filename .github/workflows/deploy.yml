name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: previoustag
        if: github.event_name == 'push'
        run: |
          echo "tag=$(git describe --tags --abbrev=0 HEAD^)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # ğŸš€ å…³é”®æ­¥éª¤ï¼šè¿è¡Œ deployï¼Œä½†å…ˆâ€œæ‹¦ä½â€ wrangler
      - name: Run deploy script (generate env, skip wrangler)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
          DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
          KV_NAMESPACE_NAME: ${{ secrets.KV_NAMESPACE_NAME }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          CUSTOM_DOMAIN: ${{ secrets.CUSTOM_DOMAIN }}
          AUTH_GITHUB_ID: ${{ secrets.AUTH_GITHUB_ID }}
          AUTH_GITHUB_SECRET: ${{ secrets.AUTH_GITHUB_SECRET }}
          AUTH_GOOGLE_ID: ${{ secrets.AUTH_GOOGLE_ID }}
          AUTH_GOOGLE_SECRET: ${{ secrets.AUTH_GOOGLE_SECRET }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
        run: |
          # 1ï¸âƒ£ fake wranglerï¼Œé˜²æ­¢è„šæœ¬åœ¨è¿™é‡Œç‚¸
          mkdir -p fakebin
          echo -e '#!/bin/sh\necho "[fake wrangler] skipped"' > fakebin/wrangler
          chmod +x fakebin/wrangler
          export PATH="$PWD/fakebin:$PATH"

          # 2ï¸âƒ£ è¿è¡Œ deployï¼ˆå…è®¸å¤±è´¥ï¼‰
          pnpm dlx tsx scripts/deploy/index.ts || true

          # 3ï¸âƒ£ æ ¡éªŒ env æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -f .env.runtime ]; then
            echo "âŒ .env.runtime was not generated"
            exit 1
          fi

          echo "âœ… .env.runtime generated"

      # ğŸ” æŠŠ dotenv å¼ºåˆ¶è½¬æˆ JSONï¼ˆè¦†ç›–åŸæ–‡ä»¶ï¼‰
      - name: Convert .env.runtime to JSON
        run: |
          node -e "
          const fs = require('fs');
          const p = '.env.runtime';
          const env = fs.readFileSync(p, 'utf8')
            .split('\n')
            .filter(l => l && !l.startsWith('#'))
            .reduce((o, l) => {
              const i = l.indexOf('=');
              if (i === -1) return o;
              o[l.slice(0, i)] = l.slice(i + 1);
              return o;
            }, {});
          fs.writeFileSync(p, JSON.stringify(env, null, 2));
          console.log('âœ… .env.runtime converted to JSON');
          "

      # ğŸ” ç”¨çœŸçš„ wrangler æ¨ secretsï¼ˆè¿™ä¸€æ­¥ç°åœ¨ä¸€å®šæˆåŠŸï¼‰
      - name: Push secrets to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          pnpm dlx wrangler pages secret bulk .env.runtime

      # ğŸ§¹ æ¸…ç†
      - name: Post deployment cleanup
        run: |
          rm -f .env*
          rm -f wrangler*.json
